#!/usr/bin/env node
/* vim: set filetype=javascript : */

var fs = require('fs'),
    colors = require('colors'),
    program = require('commander'),
    run = require('../lib/run');

program
  .usage("[options] <accessor> <file>")
  .option('-c, --colors', 'colorize output')
  .option('-n, --name-only', 'only print the names of files with matching properties')
  .parse(process.argv);

program.on('--help', function() {
  console.log('  Examples:');
  console.log('    jaq [options] "[0]" file.json');
  console.log('    jaq [options] "id" file.json');
  console.log('    jaq [options] "[0].id" file.json');
});

if(program.args.length === 0) {
  program.help();
}

var accessor = program.args[0],
    files = program.args.slice(1);

var colorize = function(str, color) {
  if(!program.colors) {
    return str;
  }

  return str[color];
};

var runFromFile = function(file, accessor) {
  fs.readFile(file, function(err, contents) {
    if(err) {
      console.log("Error reading: %s", file);
      throw err;
    }

    var result = run.inContext(accessor, contents);

    if(result) {
      console.log(colorize(file, 'cyan'));
      if(!program.nameOnly) {
        console.log(result);
      }
    }
  });
};

files.forEach(function(fileName) {
  runFromFile(fileName, accessor);
});

